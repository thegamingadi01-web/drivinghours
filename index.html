<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DriveLog Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #f1f5f9; padding-bottom: 50px; -webkit-tap-highlight-color: transparent; }
        .card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        input, select { border-bottom: 2px solid #e2e8f0; padding: 4px; background: transparent; width: 100%; }
        input[type="time"] { border: none; border-bottom: 2px solid #e2e8f0; font-size: 1.1rem; }
    </style>
</head>
<body class="p-3 font-sans text-slate-900">

    <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold italic">DriveLog Pro</h1>
        <button onclick="saveShift()" class="bg-blue-600 text-white px-5 py-2 rounded-full font-bold shadow-md active:scale-95">SAVE SHIFT</button>
    </div>

    <div class="grid grid-cols-2 gap-2 mb-4">
        <div class="bg-blue-600 p-2 rounded-xl text-center text-white">
            <div id="wD" class="text-lg font-bold">0.0h</div>
            <div class="text-[8px] uppercase font-bold opacity-80">Wk Drive (56)</div>
        </div>
        <div id="fDCard" class="bg-blue-900 p-2 rounded-xl text-center text-white">
            <div id="fD" class="text-lg font-bold">0.0h</div>
            <div class="text-[8px] uppercase font-bold opacity-80">2-Wk Drive (90)</div>
        </div>
        <div id="wWCard" class="bg-indigo-500 p-2 rounded-xl text-center text-white">
            <div id="wW" class="text-lg font-bold">0.0h</div>
            <div class="text-[8px] uppercase font-bold opacity-80">Wk WTD (60)</div>
        </div>
        <div class="bg-indigo-800 p-2 rounded-xl text-center text-white">
            <div id="fW" class="text-lg font-bold">0.0h</div>
            <div class="text-[8px] uppercase font-bold opacity-80">2-Wk WTD</div>
        </div>
    </div>

    <div class="card">
        <h2 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Shift Duty Period</h2>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="block text-[10px] text-slate-500 font-bold">Shift Start</label>
                <input type="time" id="sT">
            </div>
            <div>
                <label class="block text-[10px] text-slate-500 font-bold">Shift Finish</label>
                <input type="time" id="eT">
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3 border-t pt-3">
            <input type="number" id="sM" placeholder="Start Miles" class="text-sm">
            <input type="number" id="eM" placeholder="End Miles" class="text-sm text-right">
        </div>
    </div>

    <div class="card">
        <div class="flex justify-between items-center mb-2">
            <h2 class="font-bold text-sm text-slate-700">Tacho Activity</h2>
            <button onclick="addActivity()" class="text-blue-600 text-[10px] font-bold uppercase">+ Add Activity</button>
        </div>
        <div id="actList" class="space-y-2"></div>
        
        <div class="mt-3 pt-2 border-t flex justify-around text-center">
            <div><div id="dayDrive" class="text-sm font-bold text-blue-600">0.0h</div><div class="text-[8px] uppercase">Daily Drive</div></div>
            <div><div id="dayWork" class="text-sm font-bold text-indigo-600">0.0h</div><div class="text-[8px] uppercase">Daily Work</div></div>
            <div><div id="breakStat" class="text-[10px] font-bold text-red-500">NO BREAK</div><div class="text-[8px] uppercase">Status</div></div>
        </div>
    </div>

    <div id="hist" class="space-y-2"></div>

    <script>
        let logs = JSON.parse(localStorage.getItem('drivingLogs')) || [];
        let activities = [];

        function addActivity() {
            const id = Date.now();
            activities.push({ id, type: 'drive', s: '', e: '', d: 0 });
            const row = document.createElement('div');
            row.id = `act-${id}`;
            row.className = "flex items-center gap-1 bg-slate-50 p-2 rounded-lg border border-slate-200";
            row.innerHTML = `
                <select onchange="updateAct(${id},'type',this.value)" class="text-[10px] font-bold bg-white p-1 border rounded">
                    <option value="drive">ðŸš› DRIVE</option>
                    <option value="work">ðŸ›  WORK</option>
                    <option value="break">â˜• BREAK</option>
                </select>
                <input type="time" onchange="updateAct(${id},'s',this.value)" class="text-[10px] border-none">
                <span class="text-slate-400">-</span>
                <input type="time" onchange="updateAct(${id},'e',this.value)" class="text-[10px] border-none">
                <button onclick="rmAct(${id})" class="text-red-400 font-bold px-1 ml-1">Ã—</button>
            `;
            document.getElementById('actList').appendChild(row);
        }

        function rmAct(id) { document.getElementById(`act-${id}`).remove(); activities = activities.filter(x => x.id !== id); calcDay(); }

        function updateAct(id, f, v) {
            const a = activities.find(x => x.id === id); a[f] = v;
            if (a.s && a.e) {
                const [sh, sm] = a.s.split(':').map(Number); const [eh, em] = a.e.split(':').map(Number);
                let m = (eh * 60 + em) - (sh * 60 + sm); if (m < 0) m += 1440;
                a.d = m;
            }
            calcDay();
        }

        function calcDay() {
            let d = 0, w = 0, brks = [];
            activities.forEach(a => {
                if (a.type === 'drive') d += a.d;
                if (a.type === 'work') w += a.d;
                if (a.type === 'break') brks.push(a.d);
            });
            document.getElementById('dayDrive').innerText = (d/60).toFixed(1) + 'h';
            document.getElementById('dayWork').innerText = (w/60).toFixed(1) + 'h';
            const status = document.getElementById('breakStat');
            if (brks.some(b => b >= 45)) { status.innerText = "âœ“ 45m"; status.className="text-[10px] font-bold text-green-600"; }
            else if (brks.filter(b => b >= 15).length >= 1 && brks.some(b => b >= 30)) { status.innerText = "âœ“ 15/30"; status.className="text-[10px] font-bold text-green-600"; }
            else { status.innerText = "Ã— NO BREAK"; status.className="text-[10px] font-bold text-red-500"; }
            return { drive: d/60, work: w/60, totalWTD: (d+w)/60 };
        }

        function saveShift() {
            const day = calcDay();
            const sT = document.getElementById('sT').value;
            const eT = document.getElementById('eT').value;
            const sM = parseInt(document.getElementById('sM').value) || 0;
            const eM = parseInt(document.getElementById('eM').value) || 0;
            
            if (!sT || !eT) return alert("Enter Shift Times");
            if (activities.length === 0) return alert("Add tacho activities first");

            logs.unshift({
                date: new Date().toLocaleDateString('en-GB'),
                ts: Date.now(),
                miles: eM - sM,
                dH: day.drive,
                oH: day.work,
                tW: day.totalWTD,
                rng: `${sT} - ${eT}`
            });

            localStorage.setItem('drivingLogs', JSON.stringify(logs));
            document.getElementById('sM').value = eM;
            document.getElementById('eM').value = '';
            document.getElementById('sT').value = '';
            document.getElementById('eT').value = '';
            document.getElementById('actList').innerHTML = '';
            activities = [];
            refH();
        }

        function refH() {
            const h = document.getElementById('hist'); let wD=0, fD=0, wW=0, fW=0; const n = Date.now();
            h.innerHTML = logs.map((l, i) => {
                const a = (n - l.ts) / 86400000;
                if (a <= 7) { wD += l.dH; wW += l.tW; }
                if (a <= 14) { fD += l.dH; fW += l.tW; }
                let restLabel = "";
                if (i < logs.length - 1) {
                    const diffMs = l.ts - logs[i+1].ts;
                    const restH = (diffMs / 3600000) - logs[i+1].tW;
                    restLabel = `<div class="text-[9px] font-bold ${restH >= 9 ? 'text-green-500' : 'text-red-500'}">REST: ${restH.toFixed(1)}h</div>`;
                }
                return `
                <div class="card mb-2">
                    <div class="flex justify-between items-start mb-1">
                        <div>
                            <div class="font-bold text-xs text-slate-800">${l.date}</div>
                            <div class="text-[9px] text-slate-400 font-bold uppercase">${l.rng}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] font-bold text-blue-600">D: ${l.dH.toFixed(1)}h</div>
                            <div class="text-[10px] font-bold text-indigo-600">W: ${l.oH.toFixed(1)}h</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-1 border-t">
                        ${restLabel}
                        <div class="text-[9px] font-bold text-slate-400 uppercase">${l.miles} mi</div>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('wD').innerText = wD.toFixed(1) + 'h';
            document.getElementById('fD').innerText = fD.toFixed(1) + 'h';
            document.getElementById('wW').innerText = wW.toFixed(1) + 'h';
            document.getElementById('fW').innerText = fW.toFixed(1) + 'h';
            document.getElementById('fDCard').style.backgroundColor = fD > 90 ? '#ef4444' : '#1e3a8a';
            document.getElementById('wWCard').style.backgroundColor = wW > 60 ? '#ef4444' : '#6366f1';
        }
        refH();
    </script>
</body>
</html>
